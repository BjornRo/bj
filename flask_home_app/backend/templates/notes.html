{% extends "base.html" %} {% block header %} {% if local %}
<style>
    .colf {
        width: 460px;
    }

    .btn:focus {
        outline: none;
        box-shadow: none;
    }
</style>
{% endif %} {% endblock %} {% block title %}{{title}}{% endblock %} {% block content %} {% if local %}

<div class="row g-0">
    <div id="col" class="col-0 colf">

        <div id="scroller">
            <template id="post_template">
                <div class="card m-2 shadow collapse" id="post_id">
                    <h5 id="title" class="card-header"></h5>
                    <div id="content" class="card-body"></div>
                    <div class="card-footer">
                        <div class="btn-group" role="group">
                            <button id="delpost" type="button" class="btn btn-danger">Delete</button>
                            <button id="editpost" type="button" class="btn btn-info">Edit Post</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>


        <div class="d-flex justify-content-center my-3" id="sentinel">
            <div class="" role="status"></div>
        </div>


    </div>



    <!-- col 2 -->
    <div id="col" class="col-0 colf">
        <div class="card sticky-top mt-2 shadow">
            <h5 class="card-header d-inline">Add post</h5>
            <div class="card-body" style="float:right;">
                <textarea id="posttext" class="form-control fs-5" placeholder="Text here" style="resize: none;"
                    rows=8></textarea>
            </div>
            <div class="card-footer text-muted">
                <button id="postbtn" class="btn btn-primary" style="float: right;">Post</a>
            </div>
        </div>
    </div>
</div>


<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
    Launch demo modal
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card text-white bg-danger mb-3" style="max-width: 18rem;">
    <div class="card-header m-3">
        <h5 class="card-title">Only accessible from local network!</h5>
    </div>
</div>
{%endif%} {% endblock %} {% block script %} {% if local %}
<script type="text/javascript">
    $(".btn").removeClass("ui-btn-active");
    var scroller = document.querySelector("#scroller");
    var template = document.querySelector("#post_template");
    var sentinel = document.querySelector("#sentinel");
    var counter = 0;

    $("#postbtn").click(function (e) {
        e.preventDefault();
        var formdata = document.getElementById("posttext").value;
        if (formdata.length <= -1) {
            alert("Please enter text!");
            return;
        }
        //this.disabled = true;
        fetch("{{url_for('views.api')}}", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ newpost: formdata }),
        }).then(response => {
            if (response.status !== 200) alert("Submitting post failed")
            else {
                this.disabled = false;
                document.getElementById("posttext").value = "";
                alert("Note successfully submitted")
                response.json().then(data => {
                    add_post(data);
                    $("#" + i).collapse('show');
                });
            }
        });
    });

    function loadItems() {
        fetch(`/api?c=${counter}`).
            then((response) => {
                response.json().then((data) => {
                    //if (data.length < 10) sentinel.innerHTML = "No more posts";
                    for (var i = 0; i < data.length; i++) {
                        add_post(data[i]);
                    }
                });
            });
    };
    function add_post(data) {
        let template_clone = template.content.cloneNode(true);
        template_clone.querySelector("#title").innerHTML =
            data.time + `<span class="d-inline text-muted float-end" style="font-size: small;" id=${counter}>#${counter + 1}</span>`;
        template_clone.querySelector("#content").innerHTML = data.text.replace(/\n/g, "<br />");
        template_clone.querySelector("#delpost").value = data.time;
        template_clone.querySelector("#editpost").value = data.time;
        template_clone.querySelector("#post_id").id = "pid" + counter;
        scroller.appendChild(template_clone);
        $("#pid" + counter).collapse('show');
        counter++;
    };
    const observer = new IntersectionObserver(entries => {
        if (entries[0].intersectionRatio <= 0) return;
        loadItems();
    });
    observer.observe(sentinel);
</script>
{%endif%} {% endblock %}