{% extends "base.html" %}
{% block header %}
{% if local %}
<style>
    .gg-lock {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs, 1));
        width: 12px;
        height: 11px;
        border: 2px solid;
        border-top-right-radius: 50%;
        border-top-left-radius: 50%;
        border-bottom: transparent;
        margin-top: -12px
    }

    .gg-lock::after {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
        width: 16px;
        height: 10px;
        border-radius: 2px;
        border: 2px solid transparent;
        box-shadow: 0 0 0 2px;
        left: -4px;
        top: 9px
    }

    .gg-user {
        display: block;
        transform: scale(var(--ggs, 1));
        box-sizing: border-box;
        width: 12px;
        height: 18px
    }

    .gg-user::after,
    .gg-user::before {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
        border: 2px solid
    }

    .gg-user::before {
        width: 8px;
        height: 8px;
        border-radius: 30px;
        top: 0;
        left: 2px
    }

    .gg-user::after {
        width: 12px;
        height: 9px;
        border-bottom: 0;
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
        top: 9px
    }
</style>
{% endif %}
{% endblock %}
{% block title %}{{title}}{% endblock %}
{% block content %}
{% if not failed %}
{% if local %}
<div class="row" style="max-width: fit-content;">
    <div class="ml-3">
        {% for i,(loc_key,slot_list) in enumerate(data.items()) %}
        <div class="card m-2" style="width: 26rem;">
            <div class="card-header">
                <p class="h5">{{loc_key}}</p>
            </div>
            <ul class="list-group list-group-flush">
                {% for j,time_key in enumerate(slot_list) %}
                <li class="list-group-item">
                    <div class="container">
                        <div>
                            <p class="card-text h6" style="line-height: 31px;">{{data[loc_key][time_key]['p']}}</p>
                        </div>
                        <div style="float: right;">
                            <button class="btn btn-success btn-sm kbtn" value="loc{{i}}{{j}}">Book</button>
                            <input type="hidden" class="loc{{i}}{{j}}" value="{{loc_key}}" />
                            <input type="hidden" class="loc{{i}}{{j}}" value="{{time_key}}" />
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>
    <div id="column2" class="mt-2" style="width: 320px;display:none;">
        <div class="card">
            <div class="card-header">
                <p class="h5" id="location"></p>
            </div>
            <div class="card-body">
                <p class="h6" id="timeslot"></p>
            </div>
        </div>
        <form id="fform" class="mt-2">
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"> <i class="gg-user"></i> </span>
                    </div>
                    <input id="user" class="form-control" placeholder="Email or login" type="email">
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"> <i class="gg-lock"></i> </span>
                    </div>
                    <input id="pass" class="form-control" placeholder="******" type="password">
                </div>
            </div>
            <div class="form-group">
                <button id="submit_data" type="submit" class="btn btn-primary btn-block"> Submit </button>
            </div>
        </form>
        <div id="status" style="display: none;">
            <div class="card-header h5">Status</div>
            <div class="card-body">
                <h5 class="card-title" id="status_code"></h5>
                <div class="collapse" id="status_info">
                    <p class="card-text h6" id="status_text"></p>
                </div>
            </div>
        </div>
        <button type="button" id="cancel" class="btn btn-danger mt-2" style="display: none;">Cancel</button>
    </div>
</div>
{% else %}
<div class="card text-white bg-danger mb-3" style="max-width: 18rem;">
    <div class="card-header">
        <h5 class="card-title">Only accessible from local network!</h5>
    </div>
</div>
{%endif%}
{% else %}
<div class="card text-white bg-danger mb-3" style="max-width: 18rem;">
    <div class="card-header">
        <h5 class="card-title">Failed to get bookings.</h5>
    </div>
</div>
{%endif%}
{% endblock %}
{% block script %}
{% if local %}
<script type="text/javascript">
    var dat = {{ data | tojson}};;
    var loc_key;
    var time_key;
    var sdat;
    var exit = false;
    var tt1;
    var tt2;
    // Will store credentials in token on server later.
    var user;
    var pass;

    // Get data and show column
    $(".kbtn").click(function () {
        get_data_class($(this).val());
        document.getElementById("column2").style.display = "none";
        document.getElementById("location").innerHTML = loc_key;
        document.getElementById("timeslot").innerHTML = sdat.p;
        if (sdat.b) disp_status("Submit", "bg-success", "Bookable", "");
        else if (sdat.u === null) disp_status("Wait to book", "bg-warning", "Not unlocked", "");
        else disp_status("Try to book", "bg-warning", "Full", "");
        $("#column2").fadeIn(750);
    });
    function get_time_delay() {
        if (sdat.u === null) {
            // next date is incremented since slot is opened 24h before. Remove 30s to add some wiggleroom.
            var slot_date = new Date(time_key);
            var next_date = new Date(Date.now() + 24 * 60 * 60 * 1000 - 30 * 1000);
            return Math.ceil((slot_date - next_date) / 1000);
        } else return 90
    };
    function get_data_class(classname) {
        var htmlxs = document.getElementsByClassName(classname);
        loc_key = htmlxs[0].value;
        time_key = htmlxs[1].value;
        sdat = dat[loc_key][time_key];
    };
    // Booking routine
    $("#submit_data").click(function (e) {
        e.preventDefault();
        if (document.forms["fform"]["user"].value == "") {
            alert("Username must be filled out");
            return false;
        } else if (document.forms["fform"]["pass"].value == "") {
            alert("Password must be filled out");
            return false;
        }
        document.getElementById("fform").style.display = "none";
        document.querySelectorAll('button.kbtn').forEach(elem => {
            elem.disabled = true;
        });
        user = document.forms["fform"]["user"].value;
        pass = document.forms["fform"]["pass"].value;
        document.getElementById("fform").reset();
        if (sdat.b) book();
        else wait_to_book();
    });
    function disp_status(submit, status, msg, txt) {
        document.getElementById("status").style.display = "none";
        if (submit) document.getElementById("submit_data").innerHTML = submit;
        document.getElementById("status").className = 'card text-white mt-2 ' + status;
        document.getElementById("status_code").innerHTML = msg;
        $("#status").fadeIn(750);
        if (txt) {
            document.getElementById("status_text").innerHTML = txt;
            $("#status_info").collapse("show");
            $("#cancel").fadeIn(750);
        } else $("#status_info").collapse("hide");
    };
    function book() {
        $.ajax({
            url: "{{url_for('booking.post_data')}}",
            type: "POST",
            data: { "user": user, "pass": pass, "url": sdat.u },
            statusCode: {
                204: function () { disp_status("", "bg-danger", "204 - Reload site to try again", "") },
                200: function (data) {
                    if (data.res) disp_status("", "bg-success", "Successfully booked", "")
                    else disp_status("", "bg-danger", data.msg, "")
                }
            }
        });
        exit = true;
    };
    $("#cancel").click(function () {
        clearTimeout(tt1);
        clearTimeout(tt2);
        document.getElementById("status_code").innerHTML = "Stopped";
        document.getElementById("cancel").style.display = "none";
        document.getElementById("status_text").innerHTML = "Reload to try again.";
    });
    function wait_to_book() {
        var attempts = 0;
        var seconds = get_time_delay();
        var counter = seconds;
        disp_status("", "bg-warning", "Counting Down", seconds.toString() + "second(s)")
        var interval = 1000; // ms
        var expected = Date.now() + interval;
        tt1 = setTimeout(step, interval);
        function step() {
            var dt = Date.now() - expected; // the drift (positive for overshooting)
            counter--;
            document.getElementById("status_text").innerHTML = counter.toString() + "second(s)";
            if (counter <= 0) {
                attempts++;
                document.getElementById("status_code").innerHTML = "Trying to book";
                counter = seconds;
                $.ajax({
                    url: "{{url_for('booking.get_timeslot_data')}}",
                    type: "POST",
                    data: { "location": loc_key, "timeslot": time_key },
                    statusCode: {
                        204: function () {
                            disp_status("", "bg-danger", "204 - Reload site to try again", "")
                            exit = true;
                        },
                        200: function (data) {
                            if (data.url === null) {
                                disp_status("", "bg-danger", "Timeslot expired, stopping", "")
                                exit = true; // It's not true, but just imagine that it is.
                            } else if (data.slots != "0") book();
                            else document.getElementById("status_code").innerHTML = "Full, " + attempts.toString() + " attempts";
                        }
                    }
                }
                );
            }
            if (exit) {
                clearTimeout(tt1);
                clearTimeout(tt2);
                return;
            }
            expected += interval;
            tt2 = setTimeout(step, Math.max(0, interval - dt)); // take into account drift
        }
    };
</script>
{%endif%}{% endblock %}